---
title: "R Notebook for Climate Change Trends"
output: github_document
always_allow_html: true
---

Loading the libraries requied to analyze the datasets

```{r}

#loading the required packages
library(tidyverse)
library(corrplot)
library(VIM)
library(Hmisc)
library(psych)
library(ggplot2)
library(dplyr)
library(plotly)
library(GGally)
library(mice)
library(readr)
library(patchwork)

```

Loading the datasets

```{r}
#loading datasets
df1 <- read_csv("global-temp-annual.csv")
df2 <- read_csv("owid-co2-data.csv")

```

Summary of dataset

```{r}
#summary of datasets
cat("Dataset 1 Dimensions:", dim(df1), "\n")
cat("Dataset 2 Dimensions:", dim(df2), "\n")
cat(strrep("-", 50), "\n")
cat("Summary of Dataset 1: \n")
summary(df1)
cat(strrep("-", 50), "\n")
cat("Summary of Dataset 2: \n")
summary(df2)
cat(strrep("-", 50), "\n")
```

Examining Datasets

```{r}

cat("Dataset 1 - First 6 rows:\n")
head(df1)
cat(strrep("-", 50), "\n")
cat("Dataset 2 - First 6 rows:\n")
head(df2)
cat(strrep("-", 50), "\n")

cat("Dataset 1 data types:\n")
sapply(df1, class)
cat(strrep("-", 50), "\n")
cat("Dataset 2 data types:\n")
sapply(df2, class)
cat(strrep("-", 50), "\n")

```

Checking for Missing Values

```{r}
#analysing missing values
missing_df1 <- df1 %>%
  summarise_all(~sum(is.na(.))) %>%
  gather(key = "Variable", value = "Missing_Count") %>%
  mutate(
    Missing_Percentage = (Missing_Count / nrow(df1)) * 100,
    Present_Count = nrow(df1) - Missing_Count,
    Present_Percentage = 100 - Missing_Percentage
  ) %>%
  arrange(desc(Missing_Count))

print("Dataset 1 - Missing Values:")
print(missing_df1)

missing_df2 <- df2 %>%
  summarise_all(~sum(is.na(.))) %>%
  gather(key = "Variable", value = "Missing_Count") %>%
  mutate(
    Missing_Percentage = (Missing_Count / nrow(df2)) * 100,
    Present_Count = nrow(df2) - Missing_Count,
    Present_Percentage = 100 - Missing_Percentage
  ) %>%
  arrange(desc(Missing_Count))

print("Dataset 2 - Missing Values:")
print(missing_df2)

#visualising missing data patterns
p1 <- ggplot(missing_df1, aes(x = reorder(Variable, Missing_Percentage))) +
  geom_col(aes(y = Present_Percentage), fill = "#17becf", alpha = 0.8) +
  geom_col(aes(y = Missing_Percentage), fill = "#ff7f0e", alpha = 0.9) +
  coord_flip() +
  labs(
    title = "Missing Data Pattern - Dataset 1",
    subtitle = "Orange = Missing, Blue = Present",
    x = "Variables",
    y = "Percentage",
    caption = paste("Total observations:", nrow(df1))
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 11, color = "gray60"),
    axis.text = element_text(size = 10),
    panel.grid.minor = element_blank(),
    plot.background = element_rect(fill = "white", color = NA)
  ) +
  scale_y_continuous(labels = function(x) paste0(x, "%"))

print(p1)


p2<- ggplot(missing_df2, aes(x = reorder(Variable, Missing_Percentage))) +
  geom_col(aes(y = Present_Percentage, text = paste("Variable:", Variable, "<br>Present:", round(Present_Percentage, 1), "%")), 
           fill = "#17becf", alpha = 0.8) +
  geom_col(aes(y = Missing_Percentage, text = paste("Variable:", Variable, "<br>Missing:", round(Missing_Percentage, 1), "%")), 
           fill = "#ff7f0e", alpha = 0.9) +
  coord_flip() +
  labs(title = "Missing Data Pattern - Dataset 2",
       x = "Variables", y = "Percentage") +
  theme_minimal() +
  theme(axis.text.y = element_blank())
ggplotly(p2, tooltip = "text")

```

Identifying duplicates and unique values in Data

```{r}
cat("Dataset 1 duplicates:", sum(duplicated(df1)), "\n")
cat("Dataset 2 duplicates:", sum(duplicated(df2)), "\n")
cat(strrep("-", 50), "\n")

check_categorical <- function(df, dataset_name) {
  char_cols <- sapply(df, function(x) is.character(x) | is.factor(x))
  char_col_names <- names(df)[char_cols]
  
  for (col in char_col_names) {
    unique_count <- length(unique(df[[col]]))
    cat(sprintf("%s - %s: %d unique values\n", dataset_name, col, unique_count))
    
    if (unique_count <= 20) {
      print(table(df[[col]], useNA = "ifany"))
      cat("\n")
    }
  }
}

check_categorical(df1, "Dataset 1")
check_categorical(df2, "Dataset 2")
cat(strrep("-", 50), "\n")

```

Handling Missing Values

```{r}
handle_missing_values <- function(df, strategy = "auto") {
  df_clean <- df

  missing_pct <- df %>%
    summarise_all(~sum(is.na(.)) / length(.) * 100)
  
  #remove columns with >50% missing values
  high_missing_cols <- names(missing_pct)[missing_pct > 50]
  if (length(high_missing_cols) > 0) {
    cat("Removing columns with >50% missing values:", paste(high_missing_cols, collapse = ", "), "\n")
    df_clean <- df_clean %>% select(-all_of(high_missing_cols))
  }
  
  #handling remaining missing values
  for (col in names(df_clean)) {
    if (sum(is.na(df_clean[[col]])) > 0) {
      if (is.numeric(df_clean[[col]])) {
        #using median for numeric columns
        df_clean[[col]][is.na(df_clean[[col]])] <- median(df_clean[[col]], na.rm = TRUE)
      } else {
        #using mode for categorical columns
        mode_val <- names(sort(table(df_clean[[col]]), decreasing = TRUE))[1]
        df_clean[[col]][is.na(df_clean[[col]])] <- mode_val
      }
    }
  }
  
  return(df_clean)
}

df1_clean <- handle_missing_values(df1)
df2_clean <- handle_missing_values(df2)

cat(strrep("-", 50), "\n")
cat("Dataset 1: Rows", nrow(df1), "->", nrow(df1_clean), "after cleaning\n")
cat(strrep("-", 50), "\n")
cat("Dataset 2: Rows", nrow(df2), "->", nrow(df2_clean), "after cleaning\n")
```

Univariate Analysis

For numeric columns, we will use shapiro.test() to test if the data follows normal distribution.
Upon calculating the p-value:

- If p > 0.05: Data is likely normally distributed
- If p â‰¤ 0.05: Data significantly deviates from normal distribution

```{r}
create_univariate_plots <- function(df, dataset_name) {
  numeric_cols <- names(df)[sapply(df, is.numeric)]
  categorical_cols <- names(df)[sapply(df, is.factor)]

  for (col in numeric_cols) {
    p1 <- ggplot(df, aes(x = .data[[col]])) +
      geom_histogram(bins = 30, fill = "lightblue", alpha = 0.7) +
      ggtitle(paste("Distribution of", col)) +
      theme_minimal()
    
    p2 <- ggplot(df, aes(y = .data[[col]])) +
      geom_boxplot(fill = "lightgreen", alpha = 0.7) +
      ggtitle(paste("Boxplot of", col)) +
      theme_minimal()

    print(p1)
    print(p2)

    shapiro_test <- shapiro.test(sample(df[[col]], min(5000, length(df[[col]]))))
    cat(sprintf("%s - Shapiro-Wilk normality test p-value: %.6f\n", col, shapiro_test$p.value))
  }

  for (col in categorical_cols) {
    p <- ggplot(df, aes(x = .data[[col]])) +
      geom_bar(fill = "coral", alpha = 0.7) +
      ggtitle(paste("Distribution of", col)) +
      theme_minimal() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1))
    print(p)
  }
}

create_univariate_plots(df1_clean, "Dataset 1")
create_univariate_plots(df2_clean, "Dataset 2")
```

